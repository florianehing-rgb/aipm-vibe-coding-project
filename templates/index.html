{% extends "base.html" %}

{% block content %}
<div class="flex flex-col items-center justify-center py-20">

    <div class="text-center mb-10">
        <h1 class="text-5xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">
            Find Your Groove
        </h1>
        <p class="text-xl text-slate-400">Real-time valuation for vinyl collectors.</p>
    </div>

    <form action="/" method="POST" class="w-full max-w-2xl" id="searchForm">
        <div class="relative group">
            <div
                class="absolute -inset-1 bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg blur opacity-25 group-hover:opacity-75 transition duration-1000 group-hover:duration-200">
            </div>
            <div class="relative flex">
                <input type="text" name="query" required
                    class="block w-full p-4 pl-6 text-lg text-white bg-slate-800 border border-slate-700 rounded-l-lg focus:ring-blue-500 focus:border-blue-500 placeholder-slate-500 focus:outline-none"
                    placeholder="Artist - Album (e.g. Daft Punk - Random Access Memories)">

                <button type="submit"
                    class="p-4 px-8 text-lg font-medium text-white bg-blue-600 rounded-r-lg hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 transition-colors">
                    Scout
                </button>
            </div>
        </div>
    </form>

    <div id="loader" class="hidden mt-8 flex-col items-center">
        <div class="w-12 h-12 rounded-full border-4 border-slate-700 border-t-blue-500 animate-spin mb-4"></div>
        <p class="text-slate-400 animate-pulse">Scanning marketplaces...</p>
    </div>

    <div id="results-container" class="w-full max-w-6xl mt-8 transition-opacity duration-500 opacity-0"></div>

    {% if recent_searches %}
    <div class="mt-16 w-full max-w-2xl">
        <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-4">Recent Searches</h3>
        <div class="flex flex-wrap gap-2">
            {% for search in recent_searches %}
            <form action="/" method="POST" class="inline">
                <input type="hidden" name="query" value="{{ search.search_query }}">
                <button type="submit"
                    class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-full text-sm transition-colors border border-slate-700">
                    {{ search.search_query }}
                </button>
            </form>
            {% endfor %}
        </div>
    </div>
    {% endif %}

</div>

<script>
    document.getElementById('searchForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const loader = document.getElementById('loader');
        const resultsContainer = document.getElementById('results-container');
        const formData = new FormData(this);

        // Add partial flag
        formData.append('partial', 'true');

        // Show loader, hide previous results
        loader.classList.remove('hidden');
        loader.classList.add('flex');
        resultsContainer.classList.add('opacity-0');

        try {
            const response = await fetch('/', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const html = await response.text();
                resultsContainer.innerHTML = html;

                // Fade in results
                resultsContainer.classList.remove('opacity-0');

                // Update URL without reload (optional but nice)
                const query = formData.get('query');
                const newUrl = `/?query=${encodeURIComponent(query)}`;
                window.history.pushState({ path: newUrl }, '', newUrl);
            } else {
                resultsContainer.innerHTML = '<div class="text-red-500 text-center">Error fetching results. Please try again.</div>';
                resultsContainer.classList.remove('opacity-0');
            }
        } catch (error) {
            console.error('Error:', error);
            resultsContainer.innerHTML = '<div class="text-red-500 text-center">Network error. Please try again.</div>';
            resultsContainer.classList.remove('opacity-0');
        } finally {
            loader.classList.add('hidden');
            loader.classList.remove('flex');
        }
    });
</script>
{% endblock %}